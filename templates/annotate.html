{% extends "base.html" %}

{% block content %}
<div class="annotate-ui centered grid">
    <div class="annotate-eight wide column">
        <div class="annotate-custom-segment">
            <h2 class="ui header">Annotation Task</h2>
            
            <!-- Main Table -->
            <table class="ui celled table">
                <thead>
                    <tr class="annotate-header-row">
                        <th>Your Diagnosis</th>
                        <th>Model's Diagnosis</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Image Annotation and Model's Diagnosis -->
                    <tr>
                        <td class="annotate-image-container">
                            <div class="annotate-image-wrapper">
                                <!-- Original Image for Annotation -->
                                <img id="originalImage" src="{{ image_data.original_image_url }}" alt="Original Image">
                                <canvas id="annotationCanvas"></canvas>
                            </div>
                            <button id="clearCanvas">Clear</button>
                        </td>
                        <td class="annotate-image-container">
                            <div class="annotate-image-wrapper">
                                <!-- Grad-CAM Image -->
                                <img id="gradcamImage" src="{{ image_data.grad_cam_image_url }}" alt="Grad-CAM Image">
                            </div>
                        </td>
                    </tr>
                    <!-- DR Rating and Model Accuracy -->
                    <tr class="annotate-header-row">
                        <td>DR Rating</td>
                        <td>Model Accuracy</td>
                    </tr>
                    <tr>
                        <td>
                            <select name="diagnosis">
                                <option value="0">Normal</option>
                                <option value="1">Mild</option>
                                <option value="2">Moderate</option>
                                <option value="3">Severe</option>
                                <option value="4">Proliferative DR</option>
                            </select>
                            <button type="submit">Submit Diagnosis</button>
                        </td>
                        <td>
                            <select name="model-accuracy">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                            <button type="submit">Submit Rating</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="ui yellow button" id="nextImage">Next Image</div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('annotationCanvas');
        const ctx = canvas.getContext('2d');
        const originalImage = document.getElementById('originalImage');
        let isDrawing = false;
        let startX = 0;
        let startY = 0;

        function draw(e) {
            if (!isDrawing) return;

            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            // Set up the drawing color and line width
            ctx.strokeStyle = 'blue'; // Change 'red' to whatever color you prefer
            ctx.lineWidth = 5; // Adjust the line width as needed

        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            isDrawing = false;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.closePath();
        }


        function resizeCanvasToImage() {
            // Use the actual rendered width of the image, not just the naturalWidth
            const desiredWidth = originalImage.clientWidth; // This will get the width as rendered on the page
            const aspectRatio = originalImage.naturalHeight / originalImage.naturalWidth;
            const desiredHeight = desiredWidth * aspectRatio;

            // Set the image dimensions
            originalImage.style.width = `${desiredWidth}px`;
            originalImage.style.height = `${desiredHeight}px`;

            // Set the canvas dimensions to match the image
            canvas.width = desiredWidth;
            canvas.height = desiredHeight;

            // Adjust position if needed
            canvas.style.top = `${originalImage.offsetTop}px`;
            canvas.style.left = `${originalImage.offsetLeft}px`;
        }

        // Make sure to call resizeCanvasToImage when the image loads to set initial size
        originalImage.onload = resizeCanvasToImage; 


        // Call this function to ensure canvas is resized appropriately
        function alignCanvasWithImage() {
            if (originalImage.complete && originalImage.naturalHeight !== 0) {
                resizeCanvasToImage();
            } else {
                originalImage.onload = resizeCanvasToImage;
            }
        }

        // Setup the event listeners for drawing
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Call this function when the document is ready to ensure proper alignment
        alignCanvasWithImage();

        // Call this function on window resize with debounce to avoid performance issues
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(resizeCanvasToImage, 250); // Debounce the resize events
        });

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        document.getElementById('clearCanvas').addEventListener('click', clearCanvas);

    });

</script>

<style>
    /* General Styles */
    .annotate-custom-segment {
        background-color: #FFF;
        color: #000000;
        padding: 1rem;
    }
    .annotate-header-row th {
        width: 50%; /* Each header cell takes up half the table's width */
        text-align: center;
        background-color: #d4d4d4;
        font-weight: bold;
    }

    .annotate-image-wrapper img,
    #annotationCanvas {
        width: 400px; /* Set a fixed width for the images and canvas */
        height: auto; /* Height will scale automatically to preserve aspect ratio */
        object-fit: contain; /* Ensures the content is scaled correctly */
    }
    img {
        max-width: 100%;
        height: auto; /* Keep aspect ratio */
        display: block; /* Remove extra space below the image */
    }
    #annotationCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none; /* Ensures the image below can still trigger load events */
    }

    /* Clear Button */
    #clearCanvas {
        margin-top: 10px; /* Space above the button */
    }

    /* Dropdown and Table Styling */
    .dropdown-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    td {
        padding: 10px;
        vertical-align: middle;
    }

    /* Responsiveness and Centering */
    .annotate-ui.centered.grid {
        width: 95%; /* Increase width if necessary */
        margin: auto; /* Center grid in its container */
    }

    /* Centering the UI */
    .annotate-ui.centered.grid {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh; /* Full viewport height */
    }

    /* Ensuring content in columns is centered */
    .annotate-eight.wide.column {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    /* Image and Canvas Wrapper */
    .annotate-image-wrapper {
        position: relative; /* Establishes a positioning context for absolutely positioned elements inside */
        width: 400px; /* Fixed width for the images and canvas */
        height: auto; /* Height will scale automatically to preserve aspect ratio */
        margin: 0 auto; /* Center if necessary */
    }

    .annotate-image-wrapper img,
    .annotate-image-wrapper canvas {
        width: 100%; /* Will take the full width of the .annotate-image-wrapper */
        height: auto; /* Height will scale automatically to preserve aspect ratio */
        object-fit: contain; /* Ensures the content is scaled correctly */
        display: block; /* Will ensure no inline spacing issues */
    }

    /* Table Cell Styling */
    .annotate-header-row th, 
    .annotate-header-row td {
        width: auto; /* Allows cells to adjust based on content size */
        text-align: center; /* Center-aligns content */
        vertical-align: top; /* Aligns content to the top of the cell */
    }

    /* Ensure the canvas has pointer events enabled for drawing */
    #annotationCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: auto; /* This change allows the canvas to capture mouse events for drawing */
    }

</style>
{% endblock %}
